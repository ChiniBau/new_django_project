<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />
  </head>
  <body class="bg-light">
    <div class ="container mt-5">
      <h1>Blog Posts</h1>
      <div id="posts class="row">
        <!-- Posts will be dynamically inserted here -->

      </div>
    </div>
    <script>
      function loadPosts()
      {
      fetch("/api/posts/")
        .then((response) => response.json())
        .then((data) => {
          const container = document.querySelector("div");
          data.forEach((post) => {
            const postDiv = document.createElement("div");
            postDiv.classList.add("post");
            postDiv.innerHTML += `
                        <div class="col-md-6" id="post-${post.id}">
                            <div class="card mb-3 shadow-sm">
                                <div class="card-body" position="relative">
                                  <div class='dropdown position-absolute top-0 end-0'>
                                    <button class='btn btn-light btn-sm' data-bs-toggle='dropdown'>:</button>
                                    <ul class='dropdown-menu'>
                                      <li><a class='dropdown-item' href='#' onclick='editPost(${post.id}),(${post.title}),(${post.content})'>Edit</a></li>
                                      <li><a class='dropdown-item' href='#' onclick='deletePost(${post.id})'>Delete</a></li>
                                    </ul>
                                  </div>
                                    <h5 class="card-title">${post.title}</h5>
                                    <p class="card-text">${post.content}</p>
                                    <small class="text-muted">Published on ${post.published}</small>
                                </div>
                            </div>
                        </div>
                    `;
            container.appendChild(postDiv);
          });
        })
        .catch((error) => console.error("Error fetching posts:", error));
      
      }
      function editPost(id, title, content) {
        const postCard = document.getElementById(`post-${id}`);
        postCard.innerHTML = `
      <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <input id="edit-title-${id}" class="form-control mb-2" value="${title}">
                        <textarea id="edit-content-${id}" class="form-control mb-2">${content}</textarea>
                        <button class="btn btn-success btn-sm" onclick="savePost(${id})">Save</button>
                        <button class="btn btn-secondary btn-sm" onclick="loadPosts()">Cancel</button>
                    </div>
                </div>
                `;
              }
        function deletePost(id) {
          if (!confirm("Are you sure you want to delete this post?")) {
            return;
          }
          fetch(`/api/posts/${id}/`, {
            method: "DELETE",
            headers:{'%CSRF-Token': getCSrfToken()},
          })
            .then(res=> res.json())
            .then(()=>document.getElementById(`post-${id}`).remove())
              
        }
        function getCSrfToken(){
          const name = 'csrftoken';
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
              return cookie.substring(name.length + 1);
            }
          }
          return '';
        }

        function savePost(id) {
          const newTitle = document.getElementById(`edit-title-${id}`).value;
          const newContent = document.getElementById(`edit-content-${id}`).value;
          
          fetch(`/api/posts/${id}/`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              'X-CSRFToken': getCSrfToken(),
            },
            body: JSON.stringify({
              title: newTitle,
              content: newContent,
            }),
          })
            .then((res => res.json()))
            .then(() => loadPosts())
            
        }
        loadPosts();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
 Â </body>
</html>